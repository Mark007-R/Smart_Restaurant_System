{% extends "base.html" %}
{% block content %}

<style>
    .chat-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Chat Header */
    .chat-header {
        text-align: center;
        padding: 2.5rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-radius: 1.5rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .chat-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 0.5;
        }

        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    .chat-header h2 {
        font-size: 2.25rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
    }

    .chat-header h2 i {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .chat-header p {
        font-size: 1.1rem;
        color: #64748b;
        font-weight: 500;
        position: relative;
        z-index: 1;
    }

    /* Chat Info Card */
    .chat-info {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 1.25rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        border: 2px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
    }

    .chat-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .chat-info-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.75rem;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        position: relative;
    }

    .chat-info-icon::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: inherit;
        opacity: 0.3;
        animation: ripple 2s infinite;
    }

    @keyframes ripple {
        0% {
            transform: scale(1);
            opacity: 0.3;
        }

        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

    .chat-info-content {
        flex: 1;
    }

    .chat-info-content strong {
        color: #1e293b;
        font-size: 1.05rem;
        display: block;
        margin-bottom: 0.25rem;
    }

    .chat-info-content small {
        color: #64748b;
        font-size: 0.9rem;
    }

    /* Chat Box */
    #chat-box {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        height: 550px;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
        scroll-behavior: smooth;
        border: 2px solid rgba(102, 126, 234, 0.05);
    }

    #chat-box::-webkit-scrollbar {
        width: 10px;
    }

    #chat-box::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 10px;
    }

    #chat-box::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    #chat-box::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    /* Messages */
    .message {
        margin-bottom: 2rem;
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-user {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .message-bot {
        display: flex;
        justify-content: flex-start;
        gap: 1rem;
    }

    .message-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.3rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
    }

    .message-avatar.user {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .message-avatar.bot {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .message-avatar i {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }

    .message-content {
        max-width: 70%;
        padding: 1.25rem 1.75rem;
        border-radius: 1.25rem;
        line-height: 1.7;
        font-size: 0.95rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: relative;
    }

    .message-user .message-content {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-bot .message-content {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        color: #1e293b;
        border: 2px solid #e2e8f0;
        border-bottom-left-radius: 0.25rem;
    }

    .message-content strong {
        font-weight: 700;
    }

    .message-timestamp {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .message-bot .message-timestamp {
        color: #94a3b8;
    }

    /* Chat Form */
    #chat-form {
        background: white;
        padding: 1.25rem;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 1rem;
        align-items: center;
        border: 2px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
    }

    #chat-form:focus-within {
        border-color: #667eea;
        box-shadow: 0 8px 40px rgba(102, 126, 234, 0.2);
    }

    #question {
        flex: 1;
        border: 2px solid #e2e8f0;
        border-radius: 2rem;
        padding: 1rem 1.75rem;
        font-size: 1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #f8fafc;
    }

    #question:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        outline: none;
        background: white;
        transform: translateY(-2px);
    }

    #question::placeholder {
        color: #94a3b8;
    }

    #chat-form button {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        position: relative;
        overflow: hidden;
    }

    #chat-form button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    #chat-form button:hover:not(:disabled)::before {
        width: 300px;
        height: 300px;
    }

    #chat-form button:hover:not(:disabled) {
        transform: scale(1.15) rotate(15deg);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    #chat-form button:active:not(:disabled) {
        transform: scale(0.95);
    }

    #chat-form button:disabled {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.75rem;
        padding: 1.25rem 1.75rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 1.25rem;
        border: 2px solid #e2e8f0;
        max-width: fit-content;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
    }

    .typing-indicator.active {
        display: flex;
        animation: slideIn 0.3s ease;
    }

    .typing-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {

        0%,
        60%,
        100% {
            transform: translateY(0);
            opacity: 0.7;
        }

        30% {
            transform: translateY(-12px);
            opacity: 1;
        }
    }

    /* Suggested Questions */
    .suggested-questions {
        background: white;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-top: 2rem;
        border: 2px solid rgba(102, 126, 234, 0.05);
    }

    .suggested-questions h5 {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .suggested-questions h5 i {
        color: #667eea;
        font-size: 1.25rem;
    }

    .suggestion-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        margin: 0.5rem 0.25rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
        border: 2px solid rgba(102, 126, 234, 0.2);
        border-radius: 2rem;
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .suggestion-chip i {
        font-size: 1rem;
    }

    .suggestion-chip:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        border-color: transparent;
    }

    /* Empty Chat State */
    .empty-chat {
        text-align: center;
        padding: 4rem 2rem;
        color: #94a3b8;
    }

    .empty-chat i {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        opacity: 0.4;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse 2s ease-in-out infinite;
    }

    .empty-chat h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.75rem;
    }

    .empty-chat p {
        font-size: 1rem;
        color: #64748b;
    }

    /* RAG Source Badge */
    .rag-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: #667eea;
        margin-top: 0.75rem;
    }

    .rag-badge i {
        font-size: 1rem;
    }

    /* Voice Input Button (Future Enhancement) */
    .voice-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border: 2px solid #667eea;
        color: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .voice-btn:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .chat-header h2 {
            font-size: 1.75rem;
        }

        .message-content {
            max-width: 85%;
            padding: 1rem 1.25rem;
        }

        #chat-box {
            height: 450px;
            padding: 1.5rem;
        }

        .chat-info {
            flex-direction: column;
            text-align: center;
        }

        .suggestion-chip {
            padding: 0.6rem 1.25rem;
            font-size: 0.85rem;
        }

        #question {
            font-size: 0.95rem;
        }
    }

    /* Loading Animation */
    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }

        100% {
            background-position: 1000px 0;
        }
    }

    .loading-message {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
        border-radius: 1rem;
        height: 60px;
        width: 70%;
    }
</style>

<div class="chat-container" data-aos="fade-up">
    <!-- Chat Header -->
    <div class="chat-header" data-aos="zoom-in">
        <h2>
            <i class="fas fa-robot"></i>
            AI-Powered Chat Assistant
        </h2>
        <p class="mb-0">Powered by FAISS Vector Search & RAG Technology</p>
    </div>

    <!-- Chat Info -->
    {% if restaurant %}
    <div class="chat-info" data-aos="fade-right">
        <div class="chat-info-icon">
            <i class="fas fa-utensils"></i>
        </div>
        <div class="chat-info-content">
            <strong>
                <i class="fas fa-chart-line"></i> Currently analyzing: {{ restaurant }}
            </strong>
            <small>
                <i class="fas fa-brain"></i>
                Semantic search enabled with {{ "{:,}".format(total_reviews or 0) }} vectorized reviews
            </small>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning" data-aos="fade-down">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>No restaurant selected!</strong> Please analyze a restaurant first to enable AI chat.
        <a href="{{ url_for('index') }}" class="alert-link">
            <i class="fas fa-home"></i> Go to Home
        </a>
    </div>
    {% endif %}

    <!-- Chat Box -->
    <div id="chat-box" data-aos="fade-up" data-aos-delay="100">
        <div class="empty-chat">
            <i class="fas fa-comments"></i>
            <h5>Start Your Conversation</h5>
            <p>Ask me anything about the restaurant reviews, sentiment, or get recommendations!</p>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <span class="ms-2 text-muted">
            <i class="fas fa-brain"></i> AI is analyzing...
        </span>
    </div>

    <!-- Chat Form -->
    <form id="chat-form" data-aos="fade-up" data-aos-delay="200">
        <input type="text" id="question" name="question"
            placeholder="Ask about food quality, service, pricing, recommendations..." required autocomplete="off"
            maxlength="500">
        <button type="submit" id="sendBtn" title="Send message (Enter)">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>

    <!-- Suggested Questions -->
    <div class="suggested-questions" data-aos="fade-up" data-aos-delay="300">
        <h5>
            <i class="fas fa-lightbulb"></i>
            Quick Questions
        </h5>
        <span class="suggestion-chip" data-question="What do customers say about the food quality?">
            <i class="fas fa-utensils"></i> Food Quality
        </span>
        <span class="suggestion-chip" data-question="How is the service at this restaurant?">
            <i class="fas fa-concierge-bell"></i> Service Quality
        </span>
        <span class="suggestion-chip" data-question="Is it expensive or affordable?">
            <i class="fas fa-money-bill-wave"></i> Pricing
        </span>
        <span class="suggestion-chip" data-question="Would you recommend this restaurant?">
            <i class="fas fa-star"></i> Recommendation
        </span>
        <span class="suggestion-chip" data-question="What are the most common complaints?">
            <i class="fas fa-exclamation-circle"></i> Common Issues
        </span>
        <span class="suggestion-chip" data-question="What dishes do people recommend?">
            <i class="fas fa-heart"></i> Popular Items
        </span>
        <span class="suggestion-chip" data-question="How is the ambience and atmosphere?">
            <i class="fas fa-store"></i> Ambience
        </span>
        <span class="suggestion-chip" data-question="Is the hygiene good?">
            <i class="fas fa-shield-alt"></i> Hygiene
        </span>
    </div>
</div>

<script>
    const form = document.getElementById('chat-form');
    const box = document.getElementById('chat-box');
    const questionInput = document.getElementById('question');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    let isFirstMessage = true;
    let messageCount = 0;

    // Format timestamp
    function getTimestamp() {
        const now = new Date();
        return now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Add message to chat
    function addMessage(text, isUser = false, metadata = {}) {
        if (isFirstMessage) {
            box.innerHTML = '';
            isFirstMessage = false;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'message-user' : 'message-bot'}`;

        const avatar = document.createElement('div');
        avatar.className = `message-avatar ${isUser ? 'user' : 'bot'}`;
        avatar.innerHTML = `<i class="fas fa-${isUser ? 'user' : 'robot'}"></i>`;

        const content = document.createElement('div');
        content.className = 'message-content';

        // Enhanced formatting for bot messages
        let formattedText = text;
        if (!isUser) {
            formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/‚úÖ/g, '<span style="color: #10b981;">‚úÖ</span>')
                .replace(/‚ùå/g, '<span style="color: #ef4444;">‚ùå</span>')
                .replace(/‚ö†Ô∏è/g, '<span style="color: #f59e0b;">‚ö†Ô∏è</span>')
                .replace(/üåü/g, '<span style="color: #fbbf24;">üåü</span>');
        }

        let contentHTML = `
            ${formattedText}
            <div class="message-timestamp">
                <i class="fas fa-clock"></i> ${getTimestamp()}
            </div>
        `;

        // Add RAG badge for bot messages with sources
        if (!isUser && metadata.hasSources) {
            contentHTML += `
                <div class="rag-badge">
                    <i class="fas fa-database"></i>
                    Powered by FAISS Vector Search
                </div>
            `;
        }

        content.innerHTML = contentHTML;

        if (isUser) {
            messageDiv.appendChild(content);
            messageDiv.appendChild(avatar);
        } else {
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
        }

        box.appendChild(messageDiv);
        box.scrollTop = box.scrollHeight;

        messageCount++;

        // Add a subtle animation
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';
        setTimeout(() => {
            messageDiv.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
    }

    // Show/hide typing indicator
    function setTyping(isTyping) {
        if (isTyping) {
            typingIndicator.classList.add('active');
            sendBtn.disabled = true;
            questionInput.disabled = true;
            // Scroll to show typing indicator
            setTimeout(() => {
                box.scrollTop = box.scrollHeight;
            }, 100);
        } else {
            typingIndicator.classList.remove('active');
            sendBtn.disabled = false;
            questionInput.disabled = false;
            questionInput.focus();
        }
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const question = questionInput.value.trim();
        if (!question) return;

        // Add user message
        addMessage(question, true);
        questionInput.value = '';

        // Show typing indicator
        setTyping(true);

        try {
            // Send request to backend
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `question=${encodeURIComponent(question)}`
            });

            const data = await response.json();

            // Hide typing indicator
            setTyping(false);

            // Add bot response
            if (data.answer) {
                const hasSources = data.sources && data.sources.length > 0;
                addMessage(data.answer, false, { hasSources });
            } else if (data.error) {
                addMessage(`‚ùå **Error:** ${data.error}\n\nPlease try analyzing the restaurant first or rephrase your question.`, false);
            } else {
                addMessage("‚ö†Ô∏è I couldn't generate a response. Please try rephrasing your question or ensure the restaurant has been analyzed.", false);
            }

        } catch (error) {
            setTyping(false);
            addMessage(`‚ùå **Connection Error:** ${error.message}\n\nPlease check your internet connection and try again.`, false);
            console.error('Chat error:', error);
        }
    });

    // Handle suggested questions
    document.querySelectorAll('.suggestion-chip').forEach(chip => {
        chip.addEventListener('click', function () {
            const question = this.getAttribute('data-question');
            questionInput.value = question;
            questionInput.focus();

            // Visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 200);
        });
    });

    // Input focus effects
    questionInput.addEventListener('focus', function () {
        this.style.borderColor = '#667eea';
    });

    questionInput.addEventListener('blur', function () {
        if (!this.value) {
            this.style.borderColor = '#e2e8f0';
        }
    });

    // Character counter
    questionInput.addEventListener('input', function () {
        const remaining = 500 - this.value.length;
        if (remaining < 50) {
            console.log(`Characters remaining: ${remaining}`);
        }
    });

    // Keyboard shortcuts
    questionInput.addEventListener('keydown', function (e) {
        // Ctrl/Cmd + Enter to send
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });

    // Auto-focus input on page load
    window.addEventListener('load', () => {
        questionInput.focus();
    });

    // Easter egg: Konami code for debug mode
    let konamiCode = [];
    const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

    document.addEventListener('keydown', (e) => {
        konamiCode.push(e.key);
        konamiCode = konamiCode.slice(-10);

        if (konamiCode.join(',') === konamiSequence.join(',')) {
            console.log('üéÆ Debug mode activated!');
            console.log('Messages sent:', messageCount);
            console.log('Current restaurant:', '{{ restaurant or "None" }}');
            addMessage('üéÆ **Debug Mode Activated!**\n\nYou found the Easter egg! Message count: ' + messageCount, false);
            konamiCode = [];
        }
    });

    // Show connection status
    window.addEventListener('online', () => {
        console.log('‚úÖ Connection restored');
    });

    window.addEventListener('offline', () => {
        console.log('‚ùå Connection lost');
        addMessage('‚ö†Ô∏è **Connection Lost:** You appear to be offline. Messages will not be sent until connection is restored.', false);
    });

    // Welcome message
    setTimeout(() => {
        if (isFirstMessage && '{{ restaurant }}') {
            addMessage(
                'üëã **Welcome!**\n\n' +
                'I\'m your AI assistant powered by advanced RAG (Retrieval-Augmented Generation) technology. ' +
                'I can answer questions about **{{ restaurant }}** based on analyzed customer reviews.\n\n' +
                'üí° **Try asking:**\n' +
                '‚Ä¢ Food quality and taste\n' +
                '‚Ä¢ Service and staff behavior\n' +
                '‚Ä¢ Pricing and value\n' +
                '‚Ä¢ Ambience and atmosphere\n' +
                '‚Ä¢ Recommendations\n\n' +
                'Or click on any suggested question below!',
                false,
                { hasSources: false }
            );
            isFirstMessage = false;
        }
    }, 1000);
</script>

{% endblock %}